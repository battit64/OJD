<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tableau de Bord Ventes (V12-Recrutement)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>

    <script>
        // Force HTTPS redirection (demande utilisateur)
        if (location.protocol !== 'https:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
            location.replace('https://' + location.hostname + location.pathname + location.search);
        }
    </script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9;
        }

        @import url('https://rsms.me/inter/inter.css');

        .chart-container {
            position: relative;
            width: 100%;
            height: 400px;
            max-height: 40vh;
            margin: 0 auto;
        }

        .tab-active {
            background-color: #2563eb;
            color: white;
        }

        .tab-inactive {
            background-color: transparent;
            color: #475569;
        }

        .tab-inactive:hover {
            background-color: #e2e8f0;
        }

        th {
            position: sticky;
            top: 0;
            z-index: 10;
        }

        tbody th,
        tbody td:first-child {
            position: sticky;
            left: 0;
            background-color: white;
            z-index: 1;
        }

        .input-cell {
            width: 100%;
            border: none;
            background: transparent;
            text-align: right;
            padding: 4px;
            outline: none;
        }

        .input-cell:focus {
            background-color: #dbeafe;
            font-weight: bold;
        }

        .grid-row:hover td {
            background-color: #f8fafc;
        }
    </style>
</head>

<body class="text-slate-800 flex flex-col min-h-screen">

    <!-- LOGIN OVERLAY -->
    <div id="login-overlay"
        class="fixed inset-0 bg-slate-900 bg-opacity-90 z-50 flex flex-col items-center justify-center hidden">
        <div class="bg-white p-8 rounded-2xl shadow-2xl max-w-md w-full text-center">
            <div class="flex justify-center mb-6">
                <div class="bg-blue-600 p-4 rounded-xl shadow-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none"
                        stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline>
                        <polyline points="17 6 23 6 23 12"></polyline>
                    </svg>
                </div>
            </div>
            <h2 class="text-2xl font-bold text-slate-800 mb-2">Connexion Requise</h2>
            <p class="text-slate-500 mb-8">Veuillez vous identifier avec votre compte Google autoris√© pour acc√©der au
                tableau de bord.</p>

            <div id="g_id_onload"
                data-client_id="310662985612-csni7ojrs82j6qtksa0jdfo9pi7955nq.apps.googleusercontent.com"
                data-callback="handleCredentialResponse" data-auto_prompt="false">
            </div>
            <div class="g_id_signin" data-type="standard" data-size="large" data-theme="filled_blue"
                data-text="sign_in_with" data-shape="rectangular" data-logo_alignment="left"></div>

            <p id="login-error" class="text-red-500 text-sm mt-4 hidden"></p>
        </div>
    </div>

    <header class="bg-white shadow-sm sticky top-0 z-30 border-b border-slate-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="bg-blue-600 p-2 rounded-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                        stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline>
                        <polyline points="17 6 23 6 23 12"></polyline>
                    </svg>
                </div>
                <h1
                    class="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-700 to-blue-500 hidden sm:block">
                    PILOTAGE & OBJECTIFS PYR√âN√âES PRESSE</h1>
            </div>
            <nav class="flex space-x-2">
                <button onclick="switchTab('dashboard')" id="btn-tab-dashboard"
                    class="px-3 py-2 rounded-lg font-medium transition-all text-sm flex items-center gap-2 tab-active">Tableau
                    de Bord</button>
                <button onclick="switchTab('input')" id="btn-tab-input"
                    class="px-3 py-2 rounded-lg font-medium transition-all text-sm flex items-center gap-2 tab-inactive">Saisir
                    (Mois)</button>
                <button onclick="switchTab('bulk')" id="btn-tab-bulk"
                    class="px-3 py-2 rounded-lg font-medium transition-all text-sm flex items-center gap-2 tab-inactive">Saisie
                    (Ann√©e)</button>
                <div class="h-6 w-px bg-slate-200 mx-2"></div>
                <button onclick="logout()" id="btn-logout"
                    class="text-slate-500 hover:text-red-600 font-medium text-sm">D√©connexion</button>
            </nav>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 w-full flex-grow">
        <div id="dashboard-filters"
            class="bg-white p-4 rounded-xl shadow-sm border border-slate-200 mb-6 flex flex-wrap gap-4 justify-between items-center">
            <div class="flex gap-4 items-center">
                <div class="flex flex-col">
                    <label class="text-xs font-bold text-slate-500 uppercase">Journal</label>
                    <select id="global-journal" onchange="updateAppState()"
                        class="mt-1 block w-40 pl-3 pr-10 py-2 text-base border-slate-300 rounded-md bg-slate-50">
                        <option value="republique">La R√©publique</option>
                        <option value="eclair">L'√âclair</option>
                        <option value="republique_eclair">R√©publique + √âclair</option>
                    </select>
                </div>
                <div class="flex flex-col">
                    <label class="text-xs font-bold text-slate-500 uppercase">Ann√©e</label>
                    <select id="global-year" onchange="updateAppState()"
                        class="mt-1 block w-32 pl-3 pr-10 py-2 text-base border-slate-300 rounded-md bg-slate-50"></select>
                </div>
            </div>
            <div class="flex gap-2">
                <button onclick="exportJSON()"
                    class="p-2 text-slate-600 hover:text-blue-600 rounded-lg text-sm flex gap-2">üíæ Exporter</button>
                <label class="p-2 text-slate-600 hover:text-blue-600 rounded-lg text-sm cursor-pointer flex gap-2">üìÇ
                    Importer <input type="file" id="import-file" class="hidden" accept=".json"
                        onchange="importJSON(this)"></label>
                <div class="mx-2 h-6 w-px bg-slate-200"></div>
                <button onclick="downloadPDF()" class="p-2 text-slate-600 hover:text-red-700 text-sm flex gap-2">üìÑ
                    Rapport PDF</button>
                <button onclick="exportExcel()" class="p-2 text-slate-600 hover:text-emerald-700 text-sm flex gap-2">üìä
                    Export Excel</button>
            </div>
        </div>

        <div id="view-dashboard" class="block animate-fade-in">
            <div id="kpi-container" class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8"></div>



            <div class="bg-white rounded-xl shadow-lg border border-slate-200 p-6 mb-8">
                <h2 id="title-annual-chart" class="text-xl font-bold mb-4 text-slate-800">Historique des Ventes
                    (Moyenne
                    Jour/An) <span id="title-annual-journal" class="text-slate-500 font-semibold"></span></h2>
                <div class="chart-container"><canvas id="annualChart"></canvas></div>
            </div>

            <div class="bg-white rounded-xl shadow-lg border border-slate-200 p-6 mb-8">
                <h2 id="title-chart" class="text-xl font-bold mb-4 text-slate-800">√âvolution Mensuelle <span
                        id="title-chart-year" class="text-slate-500 font-semibold"></span></h2>
                <div class="chart-container"><canvas id="mainChart"></canvas></div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                <div class="bg-white rounded-xl shadow-lg border border-slate-200 p-6">
                    <h2 id="title-split" class="text-xl font-bold mb-4 text-slate-800">R√©partition Diffusion
                        <span id="title-split-year" class="text-slate-500 font-semibold"></span>
                    </h2>
                    <div class="chart-container"><canvas id="splitChart"></canvas></div>
                </div>
                <div class="bg-white rounded-xl shadow-lg border border-slate-200 p-6">
                    <h2 id="title-split-num" class="text-xl font-bold mb-4 text-slate-800">R√©partition Num√©rique
                        <span id="title-split-num-year" class="text-slate-500 font-semibold"></span>
                    </h2>
                    <div class="chart-container"><canvas id="splitNumChart"></canvas></div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-lg border border-slate-200 overflow-hidden mb-8">
                <h2 id="title-monthly" class="text-xl font-bold p-6 bg-white border-b border-slate-100">Synth√®se
                    Mensuelle <span id="title-monthly-year" class="text-slate-500 font-semibold"></span></h2>
                <div id="main-table-container" class="overflow-x-auto"></div>
            </div>

            <div class="bg-white rounded-xl shadow-lg border border-slate-200 overflow-hidden">
                <h2 class="text-xl font-bold p-6 text-purple-900 bg-purple-50 border-b border-purple-100">Zoom
                    Num√©rique
                    <span id="title-digital-year" class="text-purple-700 font-semibold"></span>
                </h2>


                <!-- NOUVEAUX GRAPHIQUES ZOOM NUMERIQUE -->
                <div class="p-6 grid grid-cols-1 lg:grid-cols-3 gap-8 border-b border-purple-100 bg-white">
                    <div class="lg:col-span-1 flex flex-col items-center">
                        <h3 class="text-sm font-bold text-purple-900 mb-4 uppercase">R√©partition Moyenne YTD
                        </h3>
                        <div class="relative w-full h-64">
                            <canvas id="digitalDistChart"></canvas>
                        </div>
                    </div>
                    <div class="lg:col-span-2">
                        <h3 class="text-sm font-bold text-purple-900 mb-4 uppercase text-center">√âvolution
                            Mensuelle
                            D√©taill√©e</h3>
                        <div class="bg-purple-50 p-4 rounded border border-purple-100 h-64">
                            <canvas id="digitalTrendsChart"></canvas>
                        </div>
                    </div>
                </div>

                <div id="digital-table-container" class="overflow-x-auto"></div>
            </div>

            <!-- SUIVI RECRUTEMENT / RESILIATION -->
            <div class="bg-white rounded-xl shadow-lg border border-slate-200 overflow-hidden mt-8">
                <h2 class="text-xl font-bold p-6 text-teal-900 bg-teal-50 border-b border-teal-100">Suivi
                    Recrutement &
                    R√©siliation <span id="title-recrut-year" class="text-teal-700 font-semibold"></span></h2>

                <!-- TABLEAU RECAP -->
                <div class="p-6 bg-white overflow-x-auto">
                    <table class="w-full text-sm text-left text-slate-600 border-collapse">
                        <thead class="text-xs text-slate-700 uppercase bg-slate-100 sticky top-0">
                            <tr>
                                <th class="px-2 py-2 border-b">Indicateur</th>
                                <th class="px-2 py-2 border-b text-center">JAN</th>
                                <th class="px-2 py-2 border-b text-center">FEV</th>
                                <th class="px-2 py-2 border-b text-center">MAR</th>
                                <th class="px-2 py-2 border-b text-center">AVR</th>
                                <th class="px-2 py-2 border-b text-center">MAI</th>
                                <th class="px-2 py-2 border-b text-center">JUI</th>
                                <th class="px-2 py-2 border-b text-center">JUI</th>
                                <th class="px-2 py-2 border-b text-center">AOU</th>
                                <th class="px-2 py-2 border-b text-center">SEP</th>
                                <th class="px-2 py-2 border-b text-center">OCT</th>
                                <th class="px-2 py-2 border-b text-center">NOV</th>
                                <th class="px-2 py-2 border-b text-center">DEC</th>
                                <th class="px-2 py-2 border-b text-right bg-teal-50 border-l border-teal-200">
                                    TOTAL
                                    R√©alis√©</th>
                                <th class="px-2 py-2 border-b text-right bg-slate-50 border-l border-slate-200">
                                    TOTAL
                                    Objectif</th>
                            </tr>
                        </thead>
                        <tbody id="recrut-tbody"></tbody>
                    </table>
                </div>

                <!-- GRAPHIQUES RECRUT -->
                <div class="p-6 grid grid-cols-1 lg:grid-cols-2 gap-8 bg-white border-t border-slate-200">
                    <!-- Chart 1: Recrutement -->
                    <div class="bg-teal-50 p-4 rounded border border-teal-100 h-64">
                        <h3 class="text-sm font-bold text-teal-900 mb-2 uppercase text-center">Recrutements :
                            R√©alis√© vs
                            Budget</h3>
                        <canvas id="recrutChart"></canvas>
                    </div>
                    <!-- Chart 2: R√©siliation -->
                    <div class="bg-red-50 p-4 rounded border border-red-100 h-64">
                        <h3 class="text-sm font-bold text-red-900 mb-2 uppercase text-center">R√©siliations :
                            R√©alis√©
                            vs
                            Budget</h3>
                        <canvas id="resilChart"></canvas>
                    </div>
                    <!-- Chart 3: Solde Net -->
                    <div class="lg:col-span-2 bg-slate-50 p-4 rounded border border-slate-200 h-64">
                        <h3 class="text-sm font-bold text-slate-900 mb-2 uppercase text-center">Solde Net
                            (Recrutements
                            - R√©siliations)</h3>
                        <canvas id="netBalanceChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- AUDIENCE GLOBALE -->
            <div id="section-audience"
                class="bg-white rounded-xl shadow-lg border border-slate-200 overflow-hidden mt-8">
                <h2 class="text-xl font-bold p-6 text-indigo-900 bg-indigo-50 border-b border-indigo-100">Audience
                    Globale (Millions)
                    <span id="title-audience-year" class="text-indigo-700 font-semibold"></span>
                </h2>
                <!-- Top KPIs Audience -->
                <div id="kpi-audience" class="p-6 pb-0"></div>

                <div class="p-6 flex flex-col gap-8">
                    <!-- Chart -->
                    <div class="w-full bg-white border border-slate-200 rounded p-4 h-96">
                        <h3 class="text-sm font-bold text-indigo-900 mb-2 uppercase text-center">Visites Mensuelles</h3>
                        <div class="relative w-full h-full">
                            <!-- canvas parent needs relative/full for chart.js responsive -->
                            <canvas id="audienceChart"></canvas>
                        </div>
                    </div>
                    <!-- Table -->
                    <div class="w-full overflow-x-auto">
                        <table class="w-full text-sm text-left text-slate-600 border-collapse">
                            <thead class="text-xs text-slate-700 uppercase bg-slate-100">
                                <tr>
                                    <th class="p-2 border-b">Mois</th>
                                    <th class="p-2 border-b text-center">JAN</th>
                                    <th class="p-2 border-b text-center">FEV</th>
                                    <th class="p-2 border-b text-center">MAR</th>
                                    <th class="p-2 border-b text-center">AVR</th>
                                    <th class="p-2 border-b text-center">MAI</th>
                                    <th class="p-2 border-b text-center">JUI</th>
                                    <th class="p-2 border-b text-center">JUI</th>
                                    <th class="p-2 border-b text-center">AOU</th>
                                    <th class="p-2 border-b text-center">SEP</th>
                                    <th class="p-2 border-b text-center">OCT</th>
                                    <th class="p-2 border-b text-center">NOV</th>
                                    <th class="p-2 border-b text-center">DEC</th>
                                    <th class="p-2 border-b text-center bg-slate-50 border-l">TOTAL</th>
                                </tr>
                            </thead>
                            <tbody id="audience-tbody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-input" class="hidden max-w-3xl mx-auto">
            <div class="bg-white rounded-xl shadow-lg border border-slate-200 p-8">
                <div class="text-center mb-8">
                    <h2 class="text-2xl font-bold text-slate-800">Saisie par Mois</h2>
                </div>
                <form id="data-form" onsubmit="handleFormSubmit(event)">
                    <div class="grid grid-cols-3 gap-4 mb-6 p-4 bg-slate-50 rounded-lg border border-slate-200">
                        <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Journal</label><select
                                id="form-journal" class="w-full p-2 border rounded" onchange="loadFormData()">
                                <option value="republique">La R√©publique</option>
                                <option value="eclair">L'√âclair</option>
                                <option value="republique_eclair" disabled>Combin√©</option>
                            </select></div>
                        <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Ann√©e</label><select
                                id="form-year" class="w-full p-2 border rounded" onchange="loadFormData()"></select>
                        </div>
                        <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Mois</label><select
                                id="form-month" class="w-full p-2 border rounded" onchange="loadFormData()"></select>
                        </div>
                    </div>
                    <div class="space-y-6">
                        <div>
                            <h3 class="text-sm font-bold text-blue-700 uppercase border-b border-blue-100 pb-2 mb-4">
                                Papier & VN</h3>
                            <div class="grid grid-cols-2 gap-4">
                                <div><label class="text-xs text-slate-500">Portage</label><input type="number"
                                        id="inp-porte" class="w-full p-2 border rounded"></div>
                                <div><label class="text-xs text-slate-500">Poste</label><input type="number"
                                        id="inp-poste" class="w-full p-2 border rounded"></div>
                                <div><label class="text-xs text-slate-500">VN Kiosque</label><input type="number"
                                        id="inp-ventes" class="w-full p-2 border rounded"></div>
                                <div><label class="text-xs text-slate-500">Compte Ferme</label><input type="number"
                                        id="inp-cf" class="w-full p-2 border rounded"></div>
                            </div>
                        </div>
                        <div>
                            <h3
                                class="text-sm font-bold text-purple-700 uppercase border-b border-purple-100 pb-2 mb-4">
                                Num√©rique</h3>
                            <div class="grid grid-cols-2 gap-4 bg-purple-50 p-4 rounded-lg">
                                <div><label class="text-xs text-purple-700">Abo OJD</label><input type="number"
                                        id="inp-abo-ojd" class="w-full p-2 border rounded"></div>
                                <div><label class="text-xs text-purple-700">Abo Non OJD</label><input type="number"
                                        id="inp-abo-non-ojd" class="w-full p-2 border rounded"></div>
                                <div><label class="text-xs text-purple-700">Ventes Num</label><input type="number"
                                        id="inp-ventes-num" class="w-full p-2 border rounded"></div>
                                <div><label class="text-xs text-purple-700">Applis</label><input type="number"
                                        id="inp-android" class="w-full p-2 border rounded"></div>
                            </div>
                        </div>

                        <!-- RECRUTEMENT & RESILIATION -->
                        <div>
                            <h3 class="text-sm font-bold text-teal-700 uppercase border-b border-teal-100 pb-2 mb-4">
                                Recrutement & R√©siliation</h3>
                            <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 bg-teal-50 p-4 rounded-lg">
                                <!-- Recrut -->
                                <div><label class="text-xs text-teal-800 font-bold">Recrut Print (Rep)</label><input
                                        type="number" id="recrut-print-rep" class="w-full p-2 border rounded"></div>
                                <div><label class="text-xs text-teal-800 font-bold">Recrut Print (Ecl)</label><input
                                        type="number" id="recrut-print-ecl" class="w-full p-2 border rounded"></div>
                                <div><label class="text-xs text-teal-800 font-bold">Recrut Web</label><input
                                        type="number" id="recrut-web" class="w-full p-2 border rounded"></div>
                                <div><label class="text-xs text-teal-800 font-bold">Recrut Apps</label><input
                                        type="number" id="recrut-apps" class="w-full p-2 border rounded"></div>
                                <!-- Resil -->
                                <div><label class="text-xs text-red-800 font-bold">R√©sli Print (Rep)</label><input
                                        type="number" id="resil-print-rep" class="w-full p-2 border rounded"></div>
                                <div><label class="text-xs text-red-800 font-bold">R√©sli Print (Ecl)</label><input
                                        type="number" id="resil-print-ecl" class="w-full p-2 border rounded"></div>
                                <div><label class="text-xs text-red-800 font-bold">R√©sli Web</label><input type="number"
                                        id="resil-web" class="w-full p-2 border rounded"></div>
                                <div><label class="text-xs text-red-800 font-bold">R√©sli Apps</label><input
                                        type="number" id="resil-apps" class="w-full p-2 border rounded"></div>
                            </div>
                            <!-- Budgets Recrut/Resil -->
                            <div class="grid grid-cols-4 gap-4 mt-2 p-4 bg-slate-100 rounded-lg">
                                <div><label class="text-xs text-slate-600">Obj Recrut Print</label><input type="number"
                                        id="bud-recrut-print" class="w-full p-2 border rounded bg-white"></div>
                                <div><label class="text-xs text-slate-600">Obj Recrut Web</label><input type="number"
                                        id="bud-recrut-web" class="w-full p-2 border rounded bg-white"></div>
                                <div><label class="text-xs text-slate-600">Obj Resil Print</label><input type="number"
                                        id="bud-resil-print" class="w-full p-2 border rounded bg-white"></div>
                                <div><label class="text-xs text-slate-600">Obj Resil Web</label><input type="number"
                                        id="bud-resil-web" class="w-full p-2 border rounded bg-white"></div>
                            </div>
                        </div>

                        <div>
                            <h3 class="text-sm font-bold text-amber-700 uppercase border-b border-amber-100 pb-2 mb-4">
                                Budgets Ventes</h3>
                            <div class="grid grid-cols-3 gap-4">
                                <div><label class="text-xs text-amber-700">Obj. Porte</label><input type="number"
                                        id="bud-porte" class="w-full p-2 border rounded"></div>
                                <div><label class="text-xs text-amber-700">Obj. Poste</label><input type="number"
                                        id="bud-poste" class="w-full p-2 border rounded"></div>
                                <div><label class="text-xs text-amber-700">Obj. Num</label><input type="number"
                                        id="bud-num" class="w-full p-2 border rounded"></div>
                                <div><label class="text-xs text-amber-700">Obj. Ventes</label><input type="number"
                                        id="bud-ventes" class="w-full p-2 border rounded"></div>
                                <div><label class="text-xs text-amber-700">Obj. CF</label><input type="number"
                                        id="bud-cf" class="w-full p-2 border rounded"></div>
                            </div>
                        </div>

                        <!-- AUDIENCE SECTION -->
                        <div>
                            <h3
                                class="text-sm font-bold text-indigo-700 uppercase border-b border-indigo-100 pb-2 mb-4">
                                Audience Globale (Millions)</h3>
                            <div class="grid grid-cols-2 gap-4 bg-indigo-50 p-4 rounded-lg">
                                <div><label class="text-xs text-indigo-800">Audience Visites</label><input type="number"
                                        step="0.01" id="inp-aud-visites" class="w-full p-2 border rounded"></div>
                                <div><label class="text-xs text-indigo-800">Obj. Visites</label><input type="number"
                                        step="0.01" id="inp-obj-aud-visites" class="w-full p-2 border rounded"></div>
                                <div><label class="text-xs text-indigo-800">Audience Pages</label><input type="number"
                                        step="0.01" id="inp-aud-pages" class="w-full p-2 border rounded"></div>
                                <div><label class="text-xs text-indigo-800">Obj. Pages</label><input type="number"
                                        step="0.01" id="inp-obj-aud-pages" class="w-full p-2 border rounded"></div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-8 pt-6 border-t border-slate-200"><button type="submit"
                            class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg">Enregistrer
                            le mois</button></div>
                </form>
            </div>
        </div>

        <div id="view-bulk" class="hidden w-full">
            <div class="bg-white rounded-xl shadow-lg border border-slate-200 flex flex-col h-[85vh]">
                <div class="p-4 border-b border-slate-200 flex justify-between items-center bg-slate-50 rounded-t-xl">
                    <div class="flex gap-4 items-center">
                        <h2 class="text-lg font-bold text-slate-800 flex items-center gap-2">Saisie Rapide Annuelle
                        </h2>
                        <div class="h-6 w-px bg-slate-300 mx-2"></div>
                        <select id="bulk-journal" class="p-2 border rounded text-sm" onchange="renderBulkTable()">
                            <option value="republique">La R√©publique</option>
                            <option value="eclair">L'√âclair</option>
                        </select>
                        <div class="flex items-center gap-1"><select id="bulk-year" class="p-2 border rounded text-sm"
                                onchange="renderBulkTable()"></select><button onclick="addNewYear()"
                                class="bg-blue-100 text-blue-700 px-2 py-2 rounded hover:bg-blue-200 text-xs font-bold">+
                                AN</button></div>
                    </div>
                    <div>

                        <button onclick="saveBulkData()"
                            class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-6 rounded shadow">Enregistrer
                            l'ann√©e enti√®re</button>
                    </div>
                </div>
                <div class="flex-grow overflow-auto">
                    <table class="min-w-full w-max text-sm border-collapse relative">
                        <thead
                            class="bg-slate-100 text-xs uppercase text-slate-500 font-bold sticky top-0 z-20 shadow-sm">
                            <tr>
                                <th class="p-3 border-r bg-slate-100 sticky left-0 z-30 w-24">Mois</th>
                                <th class="p-3 border-r">Portage</th>
                                <th class="p-3 border-r">Poste</th>
                                <th class="p-3 border-r bg-amber-50">V. Kiosque</th>
                                <th class="p-3 border-r bg-orange-50">C. Ferme</th>
                                <th class="p-3 border-r bg-purple-50">Abo OJD</th>
                                <th class="p-3 border-r bg-purple-50">Non OJD</th>
                                <th class="p-3 border-r bg-purple-50">Vente Num</th>
                                <th class="p-3 border-r bg-purple-50">Applis</th>
                                <!-- NEW HEADERS RECRUT/RESIL -->
                                <th class="p-3 border-r bg-teal-50">R. Print</th>
                                <th class="p-3 border-r bg-teal-50">R. Web</th>
                                <th class="p-3 border-r bg-teal-50">R. Apps</th>
                                <th class="p-3 border-r bg-red-50">S. Print</th>
                                <th class="p-3 border-r bg-red-50">S. Web</th>
                                <th class="p-3 border-r bg-red-50">S. Apps</th>
                                <!-- NEW HEADERS AUDIENCE -->
                                <th class="p-3 border-r bg-indigo-50">Aud. Vis</th>
                                <th class="p-3 border-r bg-indigo-50">Obj Vis</th>
                                <th class="p-3 border-r bg-indigo-100">Aud. Pag</th>
                                <th class="p-3 border-r bg-indigo-100">Obj Pag</th>
                                <!-- NEW HEADERS BUDGETS -->
                                <th class="p-3 border-r bg-slate-50">Obj Port</th>
                                <th class="p-3 border-r bg-slate-50">Obj Post</th>
                                <th class="p-3 border-r bg-slate-50">Obj VN</th>
                                <th class="p-3 border-r bg-slate-50">Obj CF</th>
                                <th class="p-3 border-r bg-slate-50">Obj Num</th>
                                <th class="p-3 border-r bg-slate-100">Obj R.P</th>
                                <th class="p-3 border-r bg-slate-100">Obj R.W</th>
                                <th class="p-3 border-r bg-slate-100">Obj S.P</th>
                                <th class="p-3 border-r bg-slate-100">Obj S.W</th>
                            </tr>
                        </thead>

                        <tbody id="bulk-tbody" class="divide-y divide-slate-200"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <div id="toast"
        class="fixed bottom-5 right-5 bg-emerald-600 text-white px-6 py-3 rounded-lg shadow-xl hidden transition-opacity duration-300">
        Donn√©es enregistr√©es !</div>

    <script>
        let DB_DATA = [];
        if (typeof ChartDataLabels !== 'undefined') { Chart.register(ChartDataLabels); }
        const MONTH_NAMES = ["Janvier", "F√©vrier", "Mars", "Avril", "Mai", "Juin", "Juillet", "Ao√ªt", "Septembre", "Octobre", "Novembre", "D√©cembre"];

        let mainChart = null, splitChart = null, splitNumChart = null, annualChart = null;
        // Graphs Zoom Num√©rique
        let digitalDistChart = null, digitalTrendsChart = null;
        let state = { selectedYear: new Date().getFullYear(), selectedJournal: "republique" };

        async function loadDataFromServer() {
            try {
                const res = await fetch('api.php?action=get', { cache: 'no-store' });
                if (!res.ok) throw new Error('API Error');
                const json = await res.json();
                if (Array.isArray(json)) DB_DATA = json;
            } catch (e) {
                const saved = localStorage.getItem('presse_analytics_db');
                if (saved) DB_DATA = JSON.parse(saved);
            }
        }

        async function checkSession() {
            try {
                const res = await fetch('api.php?action=check_session');
                return await res.json();
            } catch (e) {
                console.error("Session check failed", e);
                return { logged: false };
            }
        }

        async function handleCredentialResponse(response) {
            try {
                const res = await fetch('api.php?action=login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token: response.credential })
                });
                const json = await res.json();
                if (res.ok && json.status === 'ok') {
                    document.getElementById('login-overlay').classList.add('hidden');
                    applyRole(json.user);
                    loadAppData();
                } else {
                    const err = document.getElementById('login-error');
                    err.innerText = "Erreur : " + (json.error || "Inconnue");
                    err.classList.remove('hidden');
                }
            } catch (e) {
                console.error(e);
                alert("Erreur de connexion au serveur");
            }
        }

        async function logout() {
            await fetch('api.php?action=logout');
            location.reload();
        }

        function applyRole(user) {
            const isAdmin = user && user.isAdmin;
            const btnInput = document.getElementById('btn-tab-input');
            const btnBulk = document.getElementById('btn-tab-bulk');
            if (isAdmin) {
                if (btnInput) btnInput.classList.remove('hidden');
                if (btnBulk) btnBulk.classList.remove('hidden');
            } else {
                if (btnInput) btnInput.classList.add('hidden');
                if (btnBulk) btnBulk.classList.add('hidden');
                // Ensure we are not on a hidden tab
                if (document.getElementById('view-input') && !document.getElementById('view-input').classList.contains('hidden')) switchTab('dashboard');
                if (document.getElementById('view-bulk') && !document.getElementById('view-bulk').classList.contains('hidden')) switchTab('dashboard');
            }
        }

        function loadAppData() {
            loadDataFromServer().then(() => {
                populateYearSelects();
                populateMonthSelect();
                syncSelectors();
                updateDashboard();
            });
        }

        async function initApp() {
            const session = await checkSession();
            if (session.logged) {
                applyRole(session.user);
                loadAppData();
            } else {
                document.getElementById('login-overlay').classList.remove('hidden');
            }
        }

        function populateYearSelects() {
            const years = [...new Set(DB_DATA.map(d => d.year))].sort((a, b) => b - a);
            if (years.length === 0) years.push(new Date().getFullYear());
            ['global-year', 'form-year', 'bulk-year'].forEach(id => {
                const el = document.getElementById(id); if (!el) return;
                const old = parseInt(el.value); el.innerHTML = '';
                years.forEach(y => { const o = document.createElement('option'); o.value = y; o.innerText = y; el.appendChild(o); });
                if (years.includes(state.selectedYear)) el.value = state.selectedYear;
                else if (years.includes(old)) el.value = old; else el.value = years[0];
            });
            const el = document.getElementById('global-year'); if (el) state.selectedYear = parseInt(el.value);
        }

        function populateMonthSelect() {
            const el = document.getElementById('form-month');
            if (el && el.options.length === 0) {
                MONTH_NAMES.forEach((m, i) => { const o = document.createElement('option'); o.value = i + 1; o.innerText = m; el.appendChild(o); });
                el.value = new Date().getMonth() + 1;
            }
        }

        async function addNewYear() {
            const years = DB_DATA.map(d => d.year);
            const newYear = (years.length ? Math.max(...years) : new Date().getFullYear()) + 1;
            if (!confirm(`Cr√©er l'ann√©e ${newYear} ?`)) return;
            ['republique', 'eclair'].forEach(j => { for (let m = 1; m <= 12; m++) DB_DATA.push(createEmptyEntry(newYear, m, j)); });
            await saveAllData(); populateYearSelects(); state.selectedYear = newYear; syncSelectors(); renderBulkTable(); showToast(`Ann√©e ${newYear} cr√©√©e !`);
        }

        function createEmptyEntry(y, m, j) {
            return {
                id: Date.now() + Math.random(), year: y, month: m, journal: j,
                porte: 0, poste: 0, ventes: 0, cf: 0,
                abo_ojd: 0, abo_non_ojd: 0, ventes_num: 0, abo_android_apple: 0, numerique: 0,
                recrut_print_rep: 0, recrut_print_ecl: 0, recrut_web: 0, recrut_apps: 0,
                resil_print_rep: 0, resil_print_ecl: 0, resil_web: 0, resil_apps: 0,
                budget_porte: 0, budget_poste: 0, budget_num: 0, budget_ventes: 0, budget_cf: 0,
                bud_recrut_print: 0, bud_recrut_web: 0, bud_resil_print: 0, bud_resil_web: 0,
                // NEW AUDIENCE FIELDS (Millions)
                audience_visites: 0, obj_audience_visites: 0,
                audience_pages: 0, obj_audience_pages: 0
            };
        }

        async function saveAllData() {
            try {
                await fetch('api.php?action=save', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(DB_DATA) });
                localStorage.setItem('presse_analytics_db', JSON.stringify(DB_DATA));
            } catch (e) { console.error(e); alert('Erreur sauvegarde'); }
        }

        function syncSelectors() {
            document.getElementById('global-year').value = state.selectedYear;
            document.getElementById('global-journal').value = state.selectedJournal;
            document.getElementById('form-year').value = state.selectedYear;
            document.getElementById('bulk-year').value = state.selectedYear;
            if (state.selectedJournal !== 'republique_eclair') {
                document.getElementById('form-journal').value = state.selectedJournal;
                document.getElementById('bulk-journal').value = state.selectedJournal;
            }
        }

        function switchTab(t) {
            ['dashboard', 'input', 'bulk'].forEach(v => {
                const el = document.getElementById('view-' + v);
                const btn = document.getElementById('btn-tab-' + v);
                if (v === t) { el.classList.remove('hidden'); btn.classList.add('tab-active'); btn.classList.remove('tab-inactive'); }
                else { el.classList.add('hidden'); btn.classList.remove('tab-active'); btn.classList.add('tab-inactive'); }
            });
            document.getElementById('dashboard-filters').classList.toggle('hidden', t !== 'dashboard');
            if (t === 'input') loadFormData(); if (t === 'bulk') renderBulkTable(); if (t === 'dashboard') updateDashboard();
        }

        function updateAppState() {
            state.selectedYear = parseInt(document.getElementById('global-year').value);
            state.selectedJournal = document.getElementById('global-journal').value;
            syncSelectors(); updateDashboard();
        }

        function renderBulkTable() {
            const j = document.getElementById('bulk-journal').value;
            const y = parseInt(document.getElementById('bulk-year').value);
            const isRep = (j === 'republique');
            const tbody = document.getElementById('bulk-tbody'); tbody.innerHTML = '';

            // Adjust header visibility for Audience (only show if Republique ?) 
            // Actually, we need to inject the columns in the header too. 
            // For now, let's just make the input cells available.
            // But wait, the HEADERS are static in HTML. I need to make them dynamic or just always show them?
            // If I always show them, I need to handle 'eclair' logic.
            // Let's modify the header HTML in the replace block for HTML, or just let it be static and I will update HTML next.
            // Here I focus on the row generation.

            for (let m = 1; m <= 12; m++) {
                let entry = DB_DATA.find(d => d.year === y && d.month === m && d.journal === j);
                if (!entry) { entry = createEmptyEntry(y, m, j); DB_DATA.push(entry); }
                const tr = document.createElement('tr'); tr.className = 'grid-row border-b border-slate-100';

                // Audience Cells (only useful if Rep, else disabled/hidden?)
                // I will add them at the end or proper place.
                const audCells = isRep ?
                    `${bc('audience_visites', entry.audience_visites, 'bg-indigo-50')} ${bc('obj_audience_visites', entry.obj_audience_visites, 'bg-indigo-50')} 
                     ${bc('audience_pages', entry.audience_pages, 'bg-indigo-100')} ${bc('obj_audience_pages', entry.obj_audience_pages, 'bg-indigo-100')}`
                    : `<td class="border-r bg-slate-100"></td><td class="border-r bg-slate-100"></td><td class="border-r bg-slate-100"></td><td class="border-r bg-slate-100"></td>`;

                tr.innerHTML = `<td class="p-2 border-r bg-white font-bold text-slate-700 sticky left-0 z-10">${MONTH_NAMES[m - 1]}</td>
                    ${bc('porte', entry.porte)} ${bc('poste', entry.poste)} ${bc('ventes', entry.ventes, 'bg-amber-50')} ${bc('cf', entry.cf, 'bg-orange-50')}
                    ${bc('abo_ojd', entry.abo_ojd, 'bg-purple-50')} ${bc('abo_non_ojd', entry.abo_non_ojd, 'bg-purple-50')} ${bc('ventes_num', entry.ventes_num, 'bg-purple-50')} ${bc('abo_android_apple', entry.abo_android_apple, 'bg-purple-50')}
                    <!-- RECRUT / RESIL -->
                    ${bc(j === 'eclair' ? 'recrut_print_ecl' : 'recrut_print_rep', entry[j === 'eclair' ? 'recrut_print_ecl' : 'recrut_print_rep'], 'bg-teal-50')}
                    ${bc('recrut_web', entry.recrut_web, 'bg-teal-50')} ${bc('recrut_apps', entry.recrut_apps, 'bg-teal-50')}
                    ${bc(j === 'eclair' ? 'resil_print_ecl' : 'resil_print_rep', entry[j === 'eclair' ? 'resil_print_ecl' : 'resil_print_rep'], 'bg-red-50')}
                    ${bc('resil_web', entry.resil_web, 'bg-red-50')} ${bc('resil_apps', entry.resil_apps, 'bg-red-50')}
                    <!-- AUDIENCE (Visible/Active only for Rep effectively) -->
                    ${audCells}
                    <!-- BUDGETS -->
                    ${bc('budget_porte', entry.budget_porte, 'bg-slate-50')} ${bc('budget_poste', entry.budget_poste, 'bg-slate-50')}
                    ${bc('budget_ventes', entry.budget_ventes, 'bg-slate-50')} ${bc('budget_cf', entry.budget_cf, 'bg-slate-50')}
                    ${bc('budget_num', entry.budget_num, 'bg-slate-50')}
                    ${bc('bud_recrut_print', entry.bud_recrut_print, 'bg-slate-100')} ${bc('bud_recrut_web', entry.bud_recrut_web, 'bg-slate-100')}
                    ${bc('bud_resil_print', entry.bud_resil_print, 'bg-slate-100')} ${bc('bud_resil_web', entry.bud_resil_web, 'bg-slate-100')}`;
                tbody.appendChild(tr);
            }
        }
        function bc(f, v, bg = '') { return `<td class="border-r p-0 ${bg}"><input type="number" step="0.01" class="input-cell text-sm text-slate-700" data-field="${f}" value="${v || 0}"></td>`; }

        async function saveBulkData() {
            const j = document.getElementById('bulk-journal').value;
            const y = parseInt(document.getElementById('bulk-year').value);
            document.querySelectorAll('#bulk-tbody tr').forEach((tr, index) => {
                const month = index + 1;
                const idx = DB_DATA.findIndex(d => d.year === y && d.month === month && d.journal === j);
                // Fix saveBulkData to use parseFloat for audience fields or generally try parseFloat?
                // Existing fields are integers mostly, but Audience is float. parseFloat handles ints too.
                tr.querySelectorAll('input').forEach(inp => {
                    const f = inp.getAttribute('data-field');
                    // Use parseFloat for audience, parseInt for others? Or just parseFloat for all?
                    // Previous code used parseInt logic. Safest is to stick to int for others if required, but Audience needs float.
                    if (f.includes('audience')) DB_DATA[idx][f] = parseFloat(inp.value) || 0;
                    else DB_DATA[idx][f] = parseInt(inp.value) || 0;
                });
                DB_DATA[idx].numerique = (DB_DATA[idx].abo_ojd || 0) + (DB_DATA[idx].abo_non_ojd || 0) + (DB_DATA[idx].ventes_num || 0) + (DB_DATA[idx].abo_android_apple || 0);
            });
            await saveAllData(); showToast("Ann√©e compl√®te sauvegard√©e !");
        }


        function loadFormData() {
            const j = document.getElementById('form-journal').value;
            const y = parseInt(document.getElementById('form-year').value);
            const m = parseInt(document.getElementById('form-month').value);
            let d = DB_DATA.find(e => e.year === y && e.month === m && e.journal === j);
            if (!d) d = createEmptyEntry(y, m, j);

            // Populate inputs
            const fieldMap = {
                'inp-porte': 'porte', 'inp-poste': 'poste', 'inp-ventes': 'ventes', 'inp-cf': 'cf',
                'inp-abo-ojd': 'abo_ojd', 'inp-abo-non-ojd': 'abo_non_ojd', 'inp-ventes-num': 'ventes_num', 'inp-android': 'abo_android_apple',
                'recrut-print-rep': 'recrut_print_rep', 'recrut-print-ecl': 'recrut_print_ecl', 'recrut-web': 'recrut_web', 'recrut-apps': 'recrut_apps',
                'resil-print-rep': 'resil_print_rep', 'resil-print-ecl': 'resil_print_ecl', 'resil-web': 'resil_web', 'resil-apps': 'resil_apps',
                'bud-recrut-print': 'bud_recrut_print', 'bud-recrut-web': 'bud_recrut_web', 'bud-resil-print': 'bud_resil_print', 'bud-resil-web': 'bud_resil_web',
                'bud-porte': 'budget_porte', 'bud-poste': 'budget_poste', 'bud-num': 'budget_num', 'bud-ventes': 'budget_ventes', 'bud-cf': 'budget_cf',
                'inp-aud-visites': 'audience_visites', 'inp-obj-aud-visites': 'obj_audience_visites',
                'inp-aud-pages': 'audience_pages', 'inp-obj-aud-pages': 'obj_audience_pages'
            };

            for (const [id, field] of Object.entries(fieldMap)) {
                const el = document.getElementById(id);
                if (el) el.value = d[field] || 0;
            }
        }

        function renderAudienceDashboard(year) {
            const data = DB_DATA.filter(d => d.year === year && d.journal === 'republique').sort((a, b) => a.month - b.month);
            // Calculate last active month (Any audience data)
            const activeEntries = data.filter(d => (parseFloat(d.audience_visites) || 0) + (parseFloat(d.audience_pages) || 0) > 0);
            const lastM = activeEntries.length > 0 ? Math.max(...activeEntries.map(d => d.month)) : 0;

            // Aggregates
            const sum = (k) => data.reduce((a, b) => a + (b[k] || 0), 0);
            const rVis = sum('audience_visites'), bVis = sum('obj_audience_visites');
            const rPag = sum('audience_pages'), bPag = sum('obj_audience_pages');

            // Hide if no data
            const section = document.getElementById('section-audience');
            if (rVis === 0 && bVis === 0 && rPag === 0 && bPag === 0) {
                if (section) section.classList.add('hidden');
                return;
            } else {
                if (section) section.classList.remove('hidden');
            }

            // Top KPIs
            document.getElementById('kpi-audience').innerHTML = `
               <div class="grid grid-cols-2 gap-4 mb-4">
                   <div class="bg-indigo-50 p-4 rounded-lg text-center">
                        <p class="text-xs font-bold text-indigo-800 uppercase">Total Visites (Moy. Liss√©e)</p>
                        <p class="text-2xl font-bold text-indigo-900">${formatNumber(rVis)} M</p>
                        <p class="text-xs text-indigo-600">Obj: ${formatNumber(bVis)} M (${formatPercent(calcPct(rVis, bVis))})</p>
                   </div>
                   <div class="bg-indigo-100 p-4 rounded-lg text-center">
                        <p class="text-xs font-bold text-indigo-800 uppercase">Total Pages Vues (Moy. Liss√©e)</p>
                        <p class="text-2xl font-bold text-indigo-900">${formatNumber(rPag)} M</p>
                        <p class="text-xs text-indigo-600">Obj: ${formatNumber(bPag)} M (${formatPercent(calcPct(rPag, bPag))})</p>
                   </div>
               </div>
            `;

            // Table
            const row = (lbl, keyR, keyB, bg = '') => {
                let h = `<tr class="border-b ${bg}"><td class="p-2 font-bold">${lbl}</td>`;
                let tR = 0, tB = 0;
                for (let m = 1; m <= 12; m++) {
                    const isFuture = m > lastM;
                    const d = data.find(e => e.month === m) || {};
                    const r = d[keyR] || 0, b = d[keyB] || 0;
                    if (!isFuture) { tR += r; tB += b; }

                    const valR = isFuture ? '-' : (r > 0 ? r.toFixed(2) : '-');
                    const valB = isFuture ? '-' : (b > 0 ? b.toFixed(2) : '-');

                    h += `<td class="p-2 text-center text-xs relative group">
                           <div class="font-bold">${valR}</div>
                           <div class="text-[10px] text-slate-500 italic">${valB}</div>
                          </td>`;
                }
                h += `<td class="p-2 text-center font-bold border-l bg-slate-50">
                       <div>${tR.toFixed(1)}</div><div class="text-[10px] text-slate-500">${tB.toFixed(1)}</div>
                      </td></tr>`;

                // Pct Row
                h += `<tr class="border-b border-slate-200"><td class="p-2 text-right text-xs italic text-slate-500">Objectif %</td>`;
                for (let m = 1; m <= 12; m++) {
                    const isFuture = m > lastM;
                    const d = data.find(e => e.month === m) || {};
                    const r = d[keyR] || 0, b = d[keyB] || 0;

                    let val = '-', bgClass = 'bg-slate-50';
                    if (!isFuture) {
                        const p = b ? (r / b) * 100 : 0;
                        if (b > 0 && r > 0) bgClass = p >= 100 ? 'bg-emerald-200 text-emerald-800' : 'bg-red-100 text-red-800';
                        val = b ? Math.round(p) + '%' : '-';
                    }
                    h += `<td class="p-2 text-center text-xs font-bold ${bgClass}">${val}</td>`;
                }
                const totP = tB ? (tR / tB) * 100 : 0;
                h += `<td class="p-2 text-center font-bold border-l ${totP >= 100 ? 'bg-emerald-200' : 'bg-red-100'}">${tB ? Math.round(totP) + '%' : '-'}</td></tr>`;
                return h;
            };

            document.getElementById('audience-tbody').innerHTML = row('Audience Visites (M)', 'audience_visites', 'obj_audience_visites') +
                row('Audience Pages (M)', 'audience_pages', 'obj_audience_pages', 'bg-slate-50');

            // Chart
            const labs = MONTH_NAMES.map(m => m.substring(0, 3));
            // Datasets
            const dVis = [], bVisArr = [], dPag = [], bPagArr = [];
            for (let m = 1; m <= 12; m++) {
                const d = data.find(e => e.month === m) || {};
                // Map 0 to null to avoid drop in chart
                const v = (val) => (val && val !== 0 ? val : null);
                dVis.push(v(d.audience_visites)); bVisArr.push(v(d.obj_audience_visites));
                dPag.push(v(d.audience_pages)); bPagArr.push(v(d.obj_audience_pages));
            }

            const ctx = document.getElementById('audienceChart').getContext('2d');
            if (window.audChartVar) window.audChartVar.destroy();
            window.audChartVar = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labs,
                    datasets: [
                        { label: 'Visites R√©el', data: dVis, borderColor: '#4f46e5', backgroundColor: '#4f46e5', tension: 0.3 },
                        { label: 'Visites Obj', data: bVisArr, borderColor: '#818cf8', borderDash: [5, 5], pointRadius: 0, tension: 0.3 },
                        { label: 'Pages R√©el', data: dPag, borderColor: '#9333ea', backgroundColor: '#9333ea', tension: 0.3 },
                        { label: 'Pages Obj', data: bPagArr, borderColor: '#c084fc', borderDash: [5, 5], pointRadius: 0, tension: 0.3 }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false } }
            });
        }
        async function handleFormSubmit(e) {
            e.preventDefault(); const j = document.getElementById('form-journal').value, y = parseInt(document.getElementById('form-year').value), m = parseInt(document.getElementById('form-month').value);
            if (j === 'republique_eclair') return alert("Impossible sur vue combin√©e");
            const g = (id) => parseInt(document.getElementById(id).value) || 0;
            const f = (id) => parseFloat(document.getElementById(id).value) || 0;
            DB_DATA = DB_DATA.filter(d => !(d.year === y && d.month === m && d.journal === j));
            const entry = {
                id: Date.now(), year: y, month: m, journal: j,
                porte: g('inp-porte'), poste: g('inp-poste'), ventes: g('inp-ventes'), cf: g('inp-cf'),
                abo_ojd: g('inp-abo-ojd'), abo_non_ojd: g('inp-abo-non-ojd'), ventes_num: g('inp-ventes-num'), abo_android_apple: g('inp-android'),
                numerique: g('inp-abo-ojd') + g('inp-abo-non-ojd') + g('inp-ventes-num') + g('inp-android'),
                recrut_print_rep: g('recrut-print-rep'), recrut_print_ecl: g('recrut-print-ecl'), recrut_web: g('recrut-web'), recrut_apps: g('recrut-apps'),
                resil_print_rep: g('resil-print-rep'), resil_print_ecl: g('resil-print-ecl'), resil_web: g('resil-web'), resil_apps: g('resil-apps'),
                budget_porte: g('bud-porte'), budget_poste: g('bud-poste'), budget_num: g('bud-num'), budget_ventes: g('bud-ventes'), budget_cf: g('bud-cf'),
                bud_recrut_print: g('bud-recrut-print'), bud_recrut_web: g('bud-recrut-web'), bud_resil_print: g('bud-resil-print'), bud_resil_web: g('bud-resil-web'),
                // Audience
                audience_visites: f('inp-aud-visites'), obj_audience_visites: f('inp-obj-aud-visites'),
                audience_pages: f('inp-aud-pages'), obj_audience_pages: f('inp-obj-aud-pages')
            };
            DB_DATA.push(entry); await fetch('api.php?action=upsert', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(entry) }); localStorage.setItem('presse_analytics_db', JSON.stringify(DB_DATA)); showToast("Mois enregistr√© !");
        }

        // --- DASHBOARD CALCULATIONS (CORRIG√â: CAST NUMBERS) ---
        function formatNumber(n) { return (n || 0).toLocaleString('fr-FR', { maximumFractionDigits: 0 }); }
        function formatPercent(v, invert = false) {
            if (!isFinite(v)) return '-';
            let c = 'text-slate-500';
            if (v > 0) c = invert ? 'text-red-600' : 'text-emerald-600';
            else if (v < 0) c = invert ? 'text-emerald-600' : 'text-red-600';
            return `<span class="${c} text-xs font-bold">${v > 0 ? '+' : ''}${v.toFixed(1)}%</span>`;
        }
        function calcPct(c, r) { return r ? ((c - r) / r) * 100 : 0; }
        // Variance vs Abs(Budget) to handle negative budgets correctly
        function calcDiffPct(c, r) { return r ? ((c - r) / Math.abs(r)) * 100 : 0; }

        // Helper secure cast
        const safe = (v) => { const n = parseFloat(v); return isNaN(n) ? 0 : n; };

        function getAggregates(d) {
            const x = d || {};
            const n = safe(x.abo_ojd) + safe(x.abo_non_ojd) + safe(x.ventes_num) + safe(x.abo_android_apple);
            const nm = n > 0 ? n : safe(x.numerique);
            const tp = safe(x.porte) + safe(x.poste);
            return { ...x, totalPapier: tp, totalNumerique: nm, totalAbo: tp + nm, totalVentesCF: safe(x.ventes) + safe(x.cf), totalDiffusion: tp + nm + safe(x.ventes) + safe(x.cf) };
        }

        // --- MERGE FIX (CAST STRINGS TO NUMBERS) ---
        function mergeByMonth(entries, year, journalKey) {
            const byMonth = {};
            entries.forEach(d => {
                const m = d.month;
                if (!byMonth[m]) byMonth[m] = { year: year, month: m, journal: journalKey };
                for (const [k, v] of Object.entries(d)) {
                    if (['year', 'month', 'journal', 'id'].includes(k)) continue;
                    const numVal = parseFloat(v);
                    if (!isNaN(numVal)) byMonth[m][k] = (byMonth[m][k] || 0) + numVal;
                }
            });
            return Object.values(byMonth).sort((a, b) => a.month - b.month);
        }

        function updateDashboard() {
            const y = state.selectedYear, j = state.selectedJournal;
            const lMap = { republique: 'La R√©publique', eclair: "L'√âclair", republique_eclair: 'R√©publique + √âclair' };
            const jt = lMap[j] || j;
            ['title-monthly-year', 'title-digital-year', 'title-chart-year', 'title-split-year', 'title-split-num-year'].forEach(id => document.getElementById(id).textContent = `(${jt} ${y})`);
            document.getElementById('title-annual-journal').textContent = `(${jt})`;
            let currData, prevData;
            if (j === 'republique_eclair') {
                currData = mergeByMonth(DB_DATA.filter(d => d.year === y && ['republique', 'eclair'].includes(d.journal)), y, j);
                prevData = mergeByMonth(DB_DATA.filter(d => d.year === y - 1 && ['republique', 'eclair'].includes(d.journal)), y - 1, j);
            } else {
                currData = DB_DATA.filter(d => d.year === y && d.journal === j).sort((a, b) => a.month - b.month);
                prevData = DB_DATA.filter(d => d.year === y - 1 && d.journal === j);
            }
            renderAnnualChart(j); updateSplitCharts(currData); processTablesAndKPIs(currData, prevData, y); updateDigitalCharts(currData);
            renderAudienceDashboard(y);
        }

        function updateDigitalCharts(data) {
            // 1. Pr√©paration des donn√©es YTD pour le camembert
            const valid = data.filter(d => d.month);
            const denom = valid.length || 1;
            let s = { ojd: 0, nojd: 0, vn: 0, app: 0 };
            valid.forEach(d => {
                s.ojd += safe(d.abo_ojd);
                s.nojd += safe(d.abo_non_ojd);
                s.vn += safe(d.ventes_num);
                s.app += safe(d.abo_android_apple);
            });
            // Moyennes
            const piedata = [s.ojd / denom, s.nojd / denom, s.vn / denom, s.app / denom].map(Math.round);

            const ctxPie = document.getElementById('digitalDistChart');
            if (digitalDistChart) digitalDistChart.destroy();
            digitalDistChart = new Chart(ctxPie, {
                type: 'pie',
                data: {
                    labels: ['Abo OJD', 'Non OJD', 'Ventes Num', 'Applis'],
                    datasets: [{
                        data: piedata,
                        backgroundColor: ['#7c3aed', '#a78bfa', '#22c55e', '#f97316'],
                        borderWidth: 2,
                        borderColor: 'white'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { boxWidth: 10, font: { size: 10 } } },
                        datalabels: {
                            color: 'white',
                            font: { weight: 'bold', size: 11 },
                            formatter: (val, ctx) => {
                                let sum = 0;
                                let dataArr = ctx.chart.data.datasets[0].data;
                                dataArr.map(data => { sum += data; });
                                let pct = (val * 100 / sum).toFixed(0) + "%";
                                return val > 0 ? pct : '';
                            }
                        }
                    }
                }
            });

            // 2. Graphique lin√©aire combin√© (Trends 12 mois)
            // On remplace les 0 par null pour ne pas les afficher
            const labels = valid.map(d => MONTH_NAMES[d.month - 1].substring(0, 3));
            const filterZero = (v) => { const n = safe(v); return n === 0 ? null : n; };

            const dOjd = valid.map(d => filterZero(d.abo_ojd));
            const dNojd = valid.map(d => filterZero(d.abo_non_ojd));
            const dVn = valid.map(d => filterZero(d.ventes_num));
            const dApp = valid.map(d => filterZero(d.abo_android_apple));

            const ctxTrends = document.getElementById('digitalTrendsChart');
            if (digitalTrendsChart) digitalTrendsChart.destroy();

            digitalTrendsChart = new Chart(ctxTrends, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'Abo OJD', data: dOjd, borderColor: '#7c3aed', backgroundColor: '#7c3aed', tension: 0.3, spanGaps: true },
                        { label: 'Non OJD', data: dNojd, borderColor: '#a78bfa', backgroundColor: '#a78bfa', tension: 0.3, spanGaps: true },
                        { label: 'Ventes Num', data: dVn, borderColor: '#22c55e', backgroundColor: '#22c55e', tension: 0.3, spanGaps: true },
                        { label: 'Applis', data: dApp, borderColor: '#f97316', backgroundColor: '#f97316', tension: 0.3, spanGaps: true }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        legend: { position: 'bottom' },
                        datalabels: { display: false },
                        tooltip: { callbacks: { label: (c) => c.raw ? `${c.dataset.label}: ${formatNumber(c.raw)}` : '' } }
                    },
                    scales: {
                        x: { display: true },
                        y: { display: true, beginAtZero: true }
                    }
                }
            });

            // 3. Render Recruitment & Resiliation Dashboard
            renderRecrutDashboard(state.selectedYear);
        }

        // --- MANAGE RECRUT/RESIL ---
        let recrutChartVar = null, resilChartVar = null, netChartVar = null;

        function renderRecrutDashboard(year) {
            document.getElementById('title-recrut-year').innerText = year;
            // 1. Prepare Data
            const activeEntries = DB_DATA.filter(d => d.year === year && (
                (parseFloat(d.porte) || 0) + (parseFloat(d.poste) || 0) + (parseFloat(d.ventes) || 0) + (parseFloat(d.abo_ojd) || 0) > 0
            ));
            const lastM = activeEntries.length > 0 ? Math.max(...activeEntries.map(d => d.month)) : 0;

            const months = Array.from({ length: 12 }, (_, i) => i + 1);
            let dRecP = [], dRecW = [], dResP = [], dResW = [], dNet = [];
            let bRecP = [], bRecW = [], bResP = [], bResW = [];

            // Churn Arrays
            let dChurnP = [], dChurnW = [];
            let bChurnP = [], bChurnW = [];

            // Totals
            let tRecP = { r: 0, b: 0, p: 0 }, tRecW = { r: 0, b: 0, p: 0 };
            let tResP = { r: 0, b: 0, p: 0 }, tResW = { r: 0, b: 0, p: 0 };

            // Stock Totals for YTD Avg
            let tStockP = { r: 0, b: 0 }, tStockW = { r: 0, b: 0 };
            let ytdCount = 0;

            months.forEach(m => {
                const entries = DB_DATA.filter(d => d.year === year && d.month === m);
                const entriesPrev = DB_DATA.filter(d => d.year === year - 1 && d.month === m);

                let rP_Rep = 0, rP_Ecl = 0, rW = 0, rA = 0;
                let sP_Rep = 0, sP_Ecl = 0, sW = 0, sA = 0;
                let bRecP_m = 0, bRecW_m = 0, bResP_m = 0, bResW_m = 0;

                // Stocks
                let stP = 0, stW = 0;
                let bStP = 0, bStW = 0;

                entries.forEach(e => {
                    rP_Rep += safe(e.recrut_print_rep); rP_Ecl += safe(e.recrut_print_ecl); rW += safe(e.recrut_web); rA += safe(e.recrut_apps);
                    sP_Rep += safe(e.resil_print_rep); sP_Ecl += safe(e.resil_print_ecl); sW += safe(e.resil_web); sA += safe(e.resil_apps);

                    bRecP_m += safe(e.bud_recrut_print); bRecW_m += safe(e.bud_recrut_web);
                    bResP_m += safe(e.bud_resil_print); bResW_m += safe(e.bud_resil_web);

                    // Calc Stock
                    stP += safe(e.porte) + safe(e.poste);
                    const num = safe(e.abo_ojd) + safe(e.abo_non_ojd) + safe(e.ventes_num) + safe(e.abo_android_apple);
                    stW += num > 0 ? num : safe(e.numerique); // Fallback if detailed fields empty

                    bStP += safe(e.budget_porte) + safe(e.budget_poste);
                    bStW += safe(e.budget_num);
                });

                // Rule: Print = Rep + Ecl. Web = Web + Apps.
                const valRecP = rP_Rep + rP_Ecl;
                const valRecW = rW + rA;
                const valResP = sP_Rep + sP_Ecl;
                const valResW = sW + sA;

                dRecP.push(valRecP); dRecW.push(valRecW); dResP.push(valResP); dResW.push(valResW);
                bRecP.push(bRecP_m); bRecW.push(bRecW_m); bResP.push(bResP_m); bResW.push(bResW_m);
                dNet.push((valRecP + valRecW) - (valResP + valResW));

                // Churn Calculation
                // Avoid division by zero
                const chP = stP > 0 ? (valResP / stP) * 100 : 0;
                const chW = stW > 0 ? (valResW / stW) * 100 : 0;
                const bChP = bStP > 0 ? (bResP_m / bStP) * 100 : 0;
                const bChW = bStW > 0 ? (bResW_m / bStW) * 100 : 0;

                dChurnP.push(chP); dChurnW.push(chW);
                bChurnP.push(bChP); bChurnW.push(bChW);

                // Accumulate totals (YTD Only)
                if (m <= lastM) {
                    ytdCount++;
                    tRecP.r += valRecP; tRecP.b += bRecP_m;
                    tRecW.r += valRecW; tRecW.b += bRecW_m;
                    tResP.r += valResP; tResP.b += bResP_m;
                    tResW.r += valResW; tResW.b += bResW_m;

                    // N-1 YTD
                    entriesPrev.forEach(e => {
                        tRecP.p += safe(e.recrut_print_rep) + safe(e.recrut_print_ecl);
                        tRecW.p += safe(e.recrut_web) + safe(e.recrut_apps);
                        tResP.p += safe(e.resil_print_rep) + safe(e.resil_print_ecl);
                        tResW.p += safe(e.resil_web) + safe(e.resil_apps);
                    });

                    tStockP.r += stP; tStockP.b += bStP;
                    tStockW.r += stW; tStockW.b += bStW;
                }
            });

            // Calculate Total Churn (YTD Resil / Avg YTD Stock)
            const avg = (v, n) => n > 0 ? v / n : 0;
            const avgStP_r = avg(tStockP.r, ytdCount), avgStP_b = avg(tStockP.b, ytdCount);
            const avgStW_r = avg(tStockW.r, ytdCount), avgStW_b = avg(tStockW.b, ytdCount);

            const totChurnP_r = avgStP_r > 0 ? (tResP.r / avgStP_r) * 100 : 0;
            const totChurnP_b = avgStP_b > 0 ? (tResP.b / avgStP_b) * 100 : 0;

            const totChurnW_r = avgStW_r > 0 ? (tResW.r / avgStW_r) * 100 : 0;
            const totChurnW_b = avgStW_b > 0 ? (tResW.b / avgStW_b) * 100 : 0;

            // 2. Render Table
            const tbody = document.getElementById('recrut-tbody'); tbody.innerHTML = '';

            // --- HELPERS COMEX ---

            // 1. Solde Net (Level 1) - Strong Highlight
            const trNet = (lbl, data, dataBud, totR, totB) => {
                let h = `<tr class="border-b border-blue-200 bg-blue-50"><td class="px-2 py-3 font-extrabold text-blue-900 sticky left-0 bg-blue-50 border-r border-blue-100">${lbl}</td>`;
                data.forEach((v, i) => {
                    const isFuture = (i + 1) > lastM;
                    const c = v >= 0 ? 'text-emerald-700' : 'text-red-700';
                    const val = isFuture ? '-' : (v > 0 ? '+' + v : v);
                    h += `<td class="px-2 py-3 text-center font-bold text-sm ${isFuture ? 'text-slate-300' : c}">${val}</td>`;
                });
                const cTot = totR >= 0 ? 'text-emerald-800' : 'text-red-800';
                h += `<td class="px-2 py-3 text-right font-extrabold bg-blue-100 border-l border-blue-200 ${cTot} text-base">${totR > 0 ? '+' : ''}${formatNumber(totR)}</td>`;
                h += `<td class="px-2 py-3 text-right font-bold bg-slate-50 border-l border-slate-200 text-slate-400 italic">${formatNumber(totB)}</td></tr>`;
                return h;
            };

            // 2. Standard Items (Level 2) - Recrut / Resil
            const trStd = (lbl, data, totR, totB, isResil = false) => {
                let h = `<tr class="border-b border-slate-100 hover:bg-slate-50"><td class="px-2 py-2 font-bold text-slate-700 sticky left-0 bg-white">${lbl}</td>`;
                data.forEach((v, i) => {
                    const isFuture = (i + 1) > lastM;
                    const val = isFuture ? '-' : (v === 0 ? '-' : formatNumber(v));
                    const col = isResil && !isFuture ? 'text-red-600' : (isFuture ? 'text-slate-300' : 'text-slate-600');
                    h += `<td class="px-2 py-2 text-center text-xs ${col}">${val}</td>`;
                });
                h += `<td class="px-2 py-2 text-right font-bold bg-slate-50 border-l border-slate-200 text-slate-800">${formatNumber(totR)}</td>`;
                h += `<td class="px-2 py-2 text-right font-medium bg-slate-50 border-l border-slate-200 text-slate-400 italic">${formatNumber(totB)}</td></tr>`;
                return h;
            };

            // 3. Objectives & Variance (Level 3) - Attenuated
            const trObj = (dataReal, dataBud, totR, totB, type = 'pct') => { // type: 'pct' or 'diff'
                const isPct = type === 'pct';
                const lbl = isPct ? "Objectif %" : "Ecart vs Budget";
                let h = `<tr class="border-b border-slate-100"><td class="px-2 py-1 text-[10px] uppercase text-slate-400 sticky left-0 bg-white text-right italic pr-4">${lbl}</td>`;
                dataReal.forEach((v, i) => {
                    const isFuture = (i + 1) > lastM;
                    if (isFuture) {
                        h += `<td class="px-2 py-1 text-center text-[10px] text-slate-200">-</td>`;
                    } else {
                        const b = dataBud[i] || 0;
                        if (isPct) {
                            const p = b ? (v / b) * 100 : 0;
                            // Color logic: if Resil -> Low is Good. If Recrut -> High is Good.
                            // Complex to pass all context, let's keep simple color for now or specific args.
                            // Actually user asked for specific colors.
                            // Let's rely on trChurn for Churn, and this for Recrut/Resil.
                            // Implementation simplification: I will inline the logic in the main block instead of generic helper if too complex.
                            // But let's try generic.
                            // For Recrut: Green if >= 100%. Red if < 100%.
                            // For Resil: Green if <= 100%. Red if > 100%.
                            // We don't have 'isResil' here. Let's pass a color function?
                            // Let's stick to simple conditional classes in the main loop.
                            h += `<td></td>`; // Placeholder, I will use custom logic in loop
                        } else {
                            // Diff
                            const d = v - b;
                            h += `<td></td>`;
                        }
                    }
                });
                h += `<td class="bg-slate-50 border-l border-slate-200"></td><td class="bg-slate-50 border-l border-slate-200"></td></tr>`;
                return h;
            };

            // REFACTORED HELPERS FOR LEVEL 3 WITH LOGIC
            const trLvl3 = (lbl, dReal, dBud, tR, tB, invert = false, isChurn = false) => {
                let h = `<tr class="border-b border-slate-100"><td class="px-2 py-1 text-[11px] text-slate-400 sticky left-0 bg-white text-right italic pr-2">${lbl}</td>`;
                dReal.forEach((v, i) => {
                    const isFuture = (i + 1) > lastM;
                    if (isFuture) { h += `<td class="text-center text-[10px] text-slate-200">-</td>`; return; }

                    const b = dBud[i];
                    if (isChurn) {
                        // Churn Logic (Rate vs Rate)
                        // Green if v <= b. Red if v > b.
                        // Orange if "close" ? User said: "Vert : conforme. Orange : √©cart mod√©r√©. Rouge : √©cart significatif".
                        // Let's keep simple: Green / Red.
                        const c = (v <= b) ? 'text-emerald-500 font-bold' : 'text-red-500 font-bold';
                        h += `<td class="px-2 py-1 text-center text-[11px] ${c}">${b > 0 ? (v - b).toFixed(1) + ' pts' : '-'}</td>`;
                    } else {
                        // Recrut/Resil Logic (% calc)
                        // Recrut: v >= b -> Green.
                        // Resil: v <= b -> Green.
                        const p = b ? (v / b) * 100 : 0;
                        let isGood = invert ? (v <= b) : (v >= b);
                        let c = isGood ? 'text-emerald-500' : 'text-red-500';
                        if (Math.abs(p - 100) < 5) c = 'text-orange-500'; // "Moderate" window
                        h += `<td class="px-2 py-1 text-center text-[11px] ${c}">${b ? Math.round(p) + '%' : '-'}</td>`;
                    }
                });
                // YTD Column
                let totVal = '-';
                if (isChurn) {
                    const diff = tR - tB;
                    const c = diff <= 0 ? 'text-emerald-600' : 'text-red-600';
                    totVal = `<span class="${c}">${diff > 0 ? '+' : ''}${diff.toFixed(1)} pts</span>`;
                } else {
                    const p = tB ? (tR / tB) * 100 : 0;
                    const isGood = invert ? (tR <= tB) : (tR >= tB);
                    const c = isGood ? 'text-emerald-600' : 'text-red-600';
                    totVal = `<span class="${c}">${Math.round(p)}%</span>`;
                }
                h += `<td class="px-2 py-1 text-right font-bold bg-slate-50 border-l border-slate-200 text-xs">${totVal}</td>`;
                h += `<td class="bg-slate-50 border-l border-slate-200"></td></tr>`;
                return h;
            };

            const trChurn = (lbl, data, dataBud, totR, totB) => {
                let h = `<tr class="border-b border-slate-100 hover:bg-slate-50"><td class="px-2 py-2 font-bold text-slate-700 sticky left-0 bg-white">${lbl}</td>`;
                data.forEach((v, i) => {
                    const isFuture = (i + 1) > lastM;
                    if (isFuture) { h += `<td class="text-center text-xs text-slate-300">-</td>`; return; }

                    const b = dataBud[i];
                    // v <= b -> Green. v > b -> Red.
                    let c = 'text-orange-600';
                    if (b > 0) c = v <= b ? 'text-emerald-600' : 'text-red-600';
                    h += `<td class="px-2 py-2 text-center text-xs font-bold ${c}">${v.toFixed(2)}%</td>`; // Increased precision
                });
                // Tot
                const cTot = totR <= totB ? 'text-emerald-700' : 'text-red-700';
                h += `<td class="px-2 py-2 text-right font-bold bg-slate-50 border-l border-slate-200 ${cTot}">${totR.toFixed(2)}%</td>`;
                h += `<td class="px-2 py-2 text-right font-medium bg-slate-50 border-l border-slate-200 text-slate-400 italic">${totB.toFixed(2)}%</td></tr>`;
                return h;
            };


            // Calculate Deltas
            const dDeltaP = dRecP.map((v, i) => v - dResP[i]);
            const tDeltaP = { r: tRecP.r - tResP.r, b: tRecP.b - tResP.b, p: tRecP.p - tResP.p };
            const dDeltaW = dRecW.map((v, i) => v - dResW[i]);
            const tDeltaW = { r: tRecW.r - tResW.r, b: tRecW.b - tResW.b, p: tRecW.p - tResW.p };

            // --- HEADER: STATIC LEGEND (COMEX) ---
            const legendDiv = document.createElement('div');
            legendDiv.className = "mb-4 p-4 bg-white border border-slate-200 rounded-lg shadow-sm text-sm";
            legendDiv.innerHTML = `
                <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                    <div>
                        <h4 class="font-bold text-slate-700 uppercase mb-1">Guide de lecture</h4>
                        <ul class="space-y-1 text-slate-600">
                            <li><span class="inline-block w-3 h-3 bg-blue-100 border border-blue-300 mr-2"></span><strong>Solde Net</strong> : Indicateur prioritaire (Recrutements - R√©siliations).</li>
                            <li><span class="font-bold text-emerald-600">Vert</span> : Performance conforme ou sup√©rieure aux objectifs / Churn ma√Ætris√©.</li>
                            <li><span class="font-bold text-red-600">Rouge</span> : Performance inf√©rieure aux objectifs / Churn critique / Solde n√©gatif.</li>
                            <li><span class="text-slate-400">-</span> : Donn√©e future ou non disponible.</li>
                        </ul>
                    </div>
                </div>
            `;

            // Inject Legend before table
            const container = document.getElementById('recrut-tbody').closest('.bg-white');
            let legContainer = document.getElementById('comex-legend');
            if (!legContainer) {
                legContainer = document.createElement('div');
                legContainer.id = 'comex-legend';
                container.insertBefore(legContainer, container.querySelector('.overflow-x-auto'));
            }
            legContainer.innerHTML = '';
            legContainer.appendChild(legendDiv);


            // --- RENDER ROWS ---

            // PRINT SECTION
            tbody.innerHTML += `<tr><td colspan="15" class="bg-slate-200 text-slate-800 font-bold px-4 py-2 text-sm border-y border-slate-300 uppercase tracking-wider">PRINT (Rep + Ecl)</td></tr>`;

            // Level 1: Solde Net
            tbody.innerHTML += trNet('Solde Net', dDeltaP, null, tDeltaP.r, tDeltaP.b);

            // Level 2: Recrut
            tbody.innerHTML += trStd('Recrutements', dRecP, tRecP.r, tRecP.b);
            // Level 3: Obj Recrut
            tbody.innerHTML += trLvl3('Objectif %', dRecP, bRecP, tRecP.r, tRecP.b, false, false);

            // Level 2: Resil
            tbody.innerHTML += trStd('R√©siliations', dResP, tResP.r, tResP.b, true);
            // Level 3: Obj Resil
            tbody.innerHTML += trLvl3('Objectif %', dResP, bResP, tResP.r, tResP.b, true, false);

            // Level 2: Churn
            tbody.innerHTML += trChurn('Taux de Churn', dChurnP, bChurnP, totChurnP_r, totChurnP_b);
            // Level 3: Churn Var
            tbody.innerHTML += trLvl3('Ecart vs Bud', dChurnP, bChurnP, totChurnP_r, totChurnP_b, false, true); // isChurn=true

            // Spacer
            tbody.innerHTML += `<tr><td colspan="15" class="h-8 bg-white border-none"></td></tr>`;

            // WEB SECTION
            tbody.innerHTML += `<tr><td colspan="15" class="bg-slate-200 text-slate-800 font-bold px-4 py-2 text-sm border-y border-slate-300 uppercase tracking-wider">WEB (Web + Apps)</td></tr>`;

            // Level 1
            tbody.innerHTML += trNet('Solde Net', dDeltaW, null, tDeltaW.r, tDeltaW.b);

            // Level 2
            tbody.innerHTML += trStd('Recrutements', dRecW, tRecW.r, tRecW.b);
            tbody.innerHTML += trLvl3('Objectif %', dRecW, bRecW, tRecW.r, tRecW.b, false, false);

            tbody.innerHTML += trStd('R√©siliations', dResW, tResW.r, tResW.b, true);
            tbody.innerHTML += trLvl3('Objectif %', dResW, bResW, tResW.r, tResW.b, true, false);

            tbody.innerHTML += trChurn('Taux de Churn', dChurnW, bChurnW, totChurnW_r, totChurnW_b);
            tbody.innerHTML += trLvl3('Ecart vs Bud', dChurnW, bChurnW, totChurnW_r, totChurnW_b, false, true);

            // KPI CARDS UPDATE (Actionable Executive Summary)
            const kpiActionable = (lbl, val, rec, res, bud, cReal, cBud) => {
                const diffBud = val - bud;
                const pctBud = bud !== 0 ? ((val / bud - 1) * 100) : 0;

                // Colors
                const budColor = diffBud >= 0 ? 'text-emerald-600' : 'text-red-600';
                const churnColor = cReal <= cBud ? 'text-emerald-600' : 'text-orange-600';

                return `
                <div class="bg-white p-4 rounded-xl shadow border border-slate-200">
                    <p class="text-xs font-bold text-slate-500 uppercase tracking-wider">${lbl} <span class="font-normal normal-case text-slate-400">(CUMUL)</span></p>
                    <p class="text-3xl font-bold text-slate-800 mb-2 tracking-tight">${formatNumber(val)}</p>
                    <div class="flex justify-between text-[11px] mb-1">
                        <span class="text-emerald-600">Rec +${formatNumber(rec)}</span>
                        <span class="text-red-600">R√©s -${formatNumber(res)}</span>
                    </div>
                    <div class="flex justify-between text-[11px] border-t pt-2 border-slate-100">
                        <span class="text-slate-400">vs Bud (${formatNumber(bud)})</span>
                        <span class="font-bold ${budColor}">${pctBud >= 0 ? '+' : ''}${pctBud.toFixed(1)}%</span>
                    </div>
                    <div class="flex justify-between text-[11px] mt-0.5">
                        <span class="text-slate-400">Churn (Obj ${cBud.toFixed(2)}%)</span>
                        <span class="font-bold ${churnColor}">${cReal.toFixed(2)}%</span>
                    </div>
                </div>`;
            };

            // Calculate Global Churn (Weighted Average)
            const avgStGlobal_r = avgStP_r + avgStW_r;
            const avgStGlobal_b = avgStP_b + avgStW_b;
            const totChurnGlobal_r = avgStGlobal_r > 0 ? ((tResP.r + tResW.r) / avgStGlobal_r) * 100 : 0;
            const totChurnGlobal_b = avgStGlobal_b > 0 ? ((tResP.b + tResW.b) / avgStGlobal_b) * 100 : 0;

            const kp_P = kpiActionable('SOLDE NET PRINT', tDeltaP.r, tRecP.r, tResP.r, tDeltaP.b, totChurnP_r, totChurnP_b);
            const kp_W = kpiActionable('SOLDE NET NUM', tDeltaW.r, tRecW.r, tResW.r, tDeltaW.b, totChurnW_r, totChurnW_b);
            const kp_T = kpiActionable('SOLDE NET GLOBAL', tDeltaP.r + tDeltaW.r, tRecP.r + tRecW.r, tResP.r + tResW.r, tDeltaP.b + tDeltaW.b, totChurnGlobal_r, totChurnGlobal_b);

            const kpiContainer = document.getElementById('kpi-container');
            // Stack Side by Side (Grid 3)
            kpiContainer.innerHTML += `<div class="grid grid-cols-1 md:grid-cols-3 gap-6 w-full mt-8 border-t border-slate-200 pt-8">${kp_P}${kp_W}${kp_T}</div>`;

            // 3. Render Charts
            const lbs = MONTH_NAMES.map(m => m.substring(0, 3));

            // Common Options
            const opts = { responsive: true, maintainAspectRatio: false, scales: { x: { grid: { display: false } } }, interaction: { mode: 'index', intersect: false } };

            // Chart 1: Recrutement
            const ctxRec = document.getElementById('recrutChart').getContext('2d');
            if (recrutChartVar) recrutChartVar.destroy();
            recrutChartVar = new Chart(ctxRec, {
                type: 'bar',
                data: {
                    labels: lbs,
                    datasets: [
                        // Stacked Realized
                        { label: 'Print R√©alis√©', data: dRecP, backgroundColor: '#0d9488', stack: 'real' },
                        { label: 'Web R√©alis√©', data: dRecW, backgroundColor: '#5eead4', stack: 'real' },
                        // Single Budget Line
                        { type: 'line', label: 'Objectif Total', data: bRecP.map((v, i) => v + bRecW[i]), borderColor: '#b91c1c', borderWidth: 2, borderDash: [5, 5], tension: 0.1, pointRadius: 0 }
                    ]
                }, options: opts
            });

            // Chart 2: R√©siliation
            const ctxRes = document.getElementById('resilChart').getContext('2d');
            if (resilChartVar) resilChartVar.destroy();
            resilChartVar = new Chart(ctxRes, {
                type: 'bar',
                data: {
                    labels: lbs,
                    datasets: [
                        // Stacked Realized
                        { label: 'Print R√©alis√©', data: dResP, backgroundColor: '#ef4444', stack: 'real' },
                        { label: 'Web R√©alis√©', data: dResW, backgroundColor: '#fca5a5', stack: 'real' },
                        // Single Budget Line
                        { type: 'line', label: 'Objectif Total', data: bResP.map((v, i) => v + bResW[i]), borderColor: '#b91c1c', borderWidth: 2, borderDash: [5, 5], tension: 0.1, pointRadius: 0 }
                    ]
                }, options: opts
            });

            // Chart 3: Net Balance
            const ctxNet = document.getElementById('netBalanceChart').getContext('2d');
            if (netChartVar) netChartVar.destroy();
            netChartVar = new Chart(ctxNet, {
                type: 'line',
                data: {
                    labels: lbs,
                    datasets: [{
                        label: 'Solde Net (Recrut - Resil)',
                        data: dNet,
                        borderColor: '#2563eb',
                        backgroundColor: (c) => c.raw >= 0 ? 'rgba(37, 99, 235, 0.2)' : 'rgba(239, 68, 68, 0.2)',
                        fill: true,
                        tension: 0.3,
                        pointBackgroundColor: (c) => c.raw >= 0 ? '#2563eb' : '#ef4444'
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: false } }, // Self explanatory title
                    scales: { y: { beginAtZero: true } }
                }
            });
        }

        function renderAnnualChart(j) {
            const years = [...new Set(DB_DATA.map(d => d.year))].sort((a, b) => a - b);
            const aData = years.map(y => {
                let ent = (j === 'republique_eclair') ? DB_DATA.filter(d => d.year === y && ['republique', 'eclair'].includes(d.journal)) : DB_DATA.filter(d => d.year === y && d.journal === j);
                let activeM = new Set(), s = { p: 0, po: 0, n: 0, v: 0, c: 0 };
                ent.forEach(d => {
                    const agg = getAggregates(d);
                    if (agg.totalDiffusion > 0) { activeM.add(d.month); s.p += safe(d.porte); s.po += safe(d.poste); s.v += safe(d.ventes); s.c += safe(d.cf); s.n += safe(agg.totalNumerique); }
                });
                const div = activeM.size || 1;
                const p = Math.round(s.p / div), po = Math.round(s.po / div), n = Math.round(s.n / div);
                const totalAbo = (p + po + n) > 0 ? (p + po + n) : null;
                return { year: y, porte: p, poste: po, numerique: n, ventes: Math.round(s.v / div), cf: Math.round(s.c / div), totalAbo: totalAbo };
            });
            const ctx = document.getElementById('annualChart').getContext('2d');
            if (annualChart) annualChart.destroy();
            annualChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: aData.map(d => d.year),
                    datasets: [
                        { type: 'line', label: 'Total Abonn√©s', data: aData.map(d => d.totalAbo), borderColor: '#1e293b', borderWidth: 4, borderDash: [5, 5], pointBackgroundColor: '#ffffff', pointBorderColor: '#1e293b', pointRadius: 6, order: 0, fill: false, tension: 0.1, datalabels: { display: true, align: 'top', anchor: 'end', offset: 4, backgroundColor: 'rgba(255, 255, 255, 0.8)', borderRadius: 4, color: '#1e293b', font: { weight: 'bold' }, formatter: (value) => value ? `Abo: ${formatNumber(value)}` : '' } },
                        { label: 'Portage', data: aData.map(d => d.porte), backgroundColor: '#2563eb', order: 1, datalabels: { color: 'white', font: { weight: 'bold' } } },
                        { label: 'Poste', data: aData.map(d => d.poste), backgroundColor: '#0ea5e9', order: 1, datalabels: { color: 'white', font: { weight: 'bold' } } },
                        { label: 'Num√©rique', data: aData.map(d => d.numerique), backgroundColor: '#8b5cf6', order: 1, datalabels: { color: 'white', font: { weight: 'bold' } } },
                        { label: 'VN', data: aData.map(d => d.ventes), backgroundColor: '#f59e0b', order: 1, datalabels: { color: 'white', font: { weight: 'bold' } } },
                        { label: 'CF', data: aData.map(d => d.cf), backgroundColor: '#f97316', order: 1, datalabels: { color: 'white', font: { weight: 'bold' } } }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { x: { stacked: true }, y: { stacked: true } }, plugins: { datalabels: { formatter: (val) => val > 200 ? val : '' } } }
            });
        }

        function processTablesAndKPIs(cData, pData, year) {
            const activeM = cData.filter(d => getAggregates(d).totalDiffusion > 0).map(d => d.month);
            const lastM = activeM.length > 0 ? Math.max(...activeM) : 0;
            let tableRows = '', digitalRows = '', lbls = [], real = [], n1 = [], bud = [], ytd = { cnt: 0, r: {}, p: {}, b: {} };
            ['porte', 'poste', 'totalPapier', 'totalNumerique', 'totalAbo', 'ventes', 'cf', 'totalVentesCF', 'totalDiffusion', 'abo_ojd', 'abo_non_ojd', 'abo_android_apple', 'ventes_num'].forEach(k => { ytd.r[k] = 0; ytd.p[k] = 0; ytd.b[k] = 0; });

            for (let m = 1; m <= 12; m++) {
                lbls.push(MONTH_NAMES[m - 1].substring(0, 3));
                const c = getAggregates(cData.find(d => d.month === m)), p = getAggregates(pData.find(d => d.month === m));
                const rc = cData.find(d => d.month === m) || {};
                const bp = safe(rc.budget_porte), bpo = safe(rc.budget_poste), bn = safe(rc.budget_num), bv = safe(rc.budget_ventes), bcf = safe(rc.budget_cf);
                const bDiff = bp + bpo + bn + bv + bcf;
                real.push(c.totalDiffusion || null); n1.push(p.totalDiffusion || null); bud.push(bDiff || null);

                const isFuture = m > lastM;
                tableRows += `<tr class="hover:bg-slate-50 border-b border-slate-100"><td class="px-2 py-2 font-medium sticky left-0 bg-white">${MONTH_NAMES[m - 1]}</td>${tds(c.porte, bp, p.porte, '', isFuture)} ${tds(c.poste, bpo, p.poste, '', isFuture)} ${tds(c.totalPapier, bp + bpo, p.totalPapier, 'bg-slate-50', isFuture)} ${tds(c.totalNumerique, bn, p.totalNumerique, '', isFuture)} ${tds(c.totalAbo, bp + bpo + bn, p.totalAbo, 'bg-slate-100', isFuture)} ${tds(c.ventes, bv, p.ventes, 'bg-amber-50', isFuture)} ${tds(c.cf, bcf, p.cf, 'bg-orange-50', isFuture)} ${tds(c.totalVentesCF, bv + bcf, p.totalVentesCF, 'bg-amber-100', isFuture)} ${tds(c.totalDiffusion, bDiff, p.totalDiffusion, 'bg-slate-200 font-bold', isFuture)}</tr>`;
                digitalRows += `<tr class="hover:bg-purple-50 border-b border-purple-100"><td class="px-2 py-2 font-medium sticky left-0 bg-white">${MONTH_NAMES[m - 1]}</td>${td_dig(c.abo_ojd, p.abo_ojd, isFuture)} ${td_dig(c.abo_non_ojd, p.abo_non_ojd, isFuture)} ${td_dig(c.ventes_num, p.ventes_num, isFuture)} ${td_dig(c.abo_android_apple, p.abo_android_apple, isFuture)} <td class="text-right font-bold bg-purple-100 border-l px-2">${isFuture ? '-' : formatNumber(c.totalNumerique)}</td><td class="text-center bg-purple-100 px-2">${isFuture ? '-' : formatPercent(calcPct(c.totalNumerique, p.totalNumerique))}</td></tr>`;

                if (!isFuture) {
                    ytd.cnt++;
                    const add = (t, o, k, v) => { t[o][k] += safe(v) };
                    add(ytd, 'r', 'porte', c.porte); add(ytd, 'p', 'porte', p.porte); add(ytd, 'b', 'porte', bp);
                    add(ytd, 'r', 'poste', c.poste); add(ytd, 'p', 'poste', p.poste); add(ytd, 'b', 'poste', bpo);
                    add(ytd, 'r', 'totalPapier', c.totalPapier); add(ytd, 'p', 'totalPapier', p.totalPapier); add(ytd, 'b', 'totalPapier', bp + bpo);
                    add(ytd, 'r', 'totalNumerique', c.totalNumerique); add(ytd, 'p', 'totalNumerique', p.totalNumerique); add(ytd, 'b', 'totalNumerique', bn);
                    add(ytd, 'r', 'totalAbo', c.totalAbo); add(ytd, 'p', 'totalAbo', p.totalAbo); add(ytd, 'b', 'totalAbo', bp + bpo + bn);
                    add(ytd, 'r', 'ventes', c.ventes); add(ytd, 'p', 'ventes', p.ventes); add(ytd, 'b', 'ventes', bv);
                    add(ytd, 'r', 'cf', c.cf); add(ytd, 'p', 'cf', p.cf); add(ytd, 'b', 'cf', bcf);
                    add(ytd, 'r', 'totalVentesCF', c.totalVentesCF); add(ytd, 'p', 'totalVentesCF', p.totalVentesCF); add(ytd, 'b', 'totalVentesCF', bv + bcf);
                    add(ytd, 'r', 'totalDiffusion', c.totalDiffusion); add(ytd, 'p', 'totalDiffusion', p.totalDiffusion); add(ytd, 'b', 'totalDiffusion', bDiff);
                    add(ytd, 'r', 'abo_ojd', c.abo_ojd); add(ytd, 'p', 'abo_ojd', p.abo_ojd);
                    add(ytd, 'r', 'abo_non_ojd', c.abo_non_ojd); add(ytd, 'p', 'abo_non_ojd', p.abo_non_ojd);
                    add(ytd, 'r', 'ventes_num', c.ventes_num); add(ytd, 'p', 'ventes_num', p.ventes_num);
                    add(ytd, 'r', 'abo_android_apple', c.abo_android_apple); add(ytd, 'p', 'abo_android_apple', p.abo_android_apple);
                }
            }

            const kAvg = (k) => ytd.cnt ? Math.round(ytd.r[k] / ytd.cnt) : 0; const kPrev = (k) => ytd.cnt ? Math.round(ytd.p[k] / ytd.cnt) : 0; const kBud = (k) => ytd.cnt ? Math.round(ytd.b[k] / ytd.cnt) : 0;
            document.getElementById('kpi-container').innerHTML = [{ l: "Total Diffusion", k: "totalDiffusion" }, { l: "Total Abonn√©s", k: "totalAbo" }, { l: "VN + CF", k: "totalVentesCF" }].map(i => `<div class="bg-white p-4 rounded-xl shadow border border-slate-200"><p class="text-xs font-bold text-slate-500 uppercase">${i.l} (Moy. Liss√©e)</p><p class="text-3xl font-bold text-slate-800 mb-2">${formatNumber(kAvg(i.k))}</p><div class="flex justify-between text-xs border-t pt-2"><span class="text-slate-400">vs N-1 (${formatNumber(kPrev(i.k))})</span>${formatPercent(calcPct(kAvg(i.k), kPrev(i.k)))}</div><div class="flex justify-between text-xs"><span class="text-slate-400">vs Bud (${formatNumber(kBud(i.k))})</span>${formatPercent(calcPct(kAvg(i.k), kBud(i.k)))}</div></div>`).join('');

            const th = `<thead class="bg-slate-100 text-xs"><tr class="border-b"><th class="p-2 z-20">Mois</th><th colspan="4" class="text-center border-l bg-blue-50">Portage</th><th colspan="4" class="text-center border-l bg-sky-50">Poste</th><th colspan="4" class="text-center border-l">Abo Papier</th><th colspan="4" class="text-center border-l bg-purple-50">Num√©rique</th><th colspan="4" class="text-center border-l">Total Abo</th><th colspan="4" class="text-center border-l bg-amber-50">VN</th><th colspan="4" class="text-center border-l bg-orange-50">CF</th><th colspan="4" class="text-center border-l">VN+CF</th><th colspan="4" class="text-center border-l bg-slate-800 text-white">Total</th></tr><tr class="text-slate-500"><th class="p-2 bg-white"></th>${Array(9).fill('').map(() => '<th class="px-1 text-right border-l">R√©el</th><th class="px-1 text-right">Bud</th><th class="px-1 text-center">%B</th><th class="px-1 text-center">%N-1</th>').join('')}</tr></thead>`;
            const yRow = `<tr class="bg-blue-50 border-b-2 border-blue-200 font-bold text-blue-900"><td class="px-2 py-2 sticky left-0 bg-blue-50 z-10">MOY. LISS√âE</td>${['porte', 'poste', 'totalPapier', 'totalNumerique', 'totalAbo', 'ventes', 'cf', 'totalVentesCF', 'totalDiffusion'].map(k => tdsYTD(ytd, k)).join(' ')}</tr>`;
            document.getElementById('main-table-container').innerHTML = `<table class="w-full text-xs whitespace-nowrap">${th}<tbody>${yRow}${tableRows}</tbody></table>`;

            const dh = `<thead class="bg-purple-50 text-xs"><tr class="border-b border-purple-200"><th class="p-2">Mois</th><th colspan="2" class="text-center border-l">Abo OJD</th><th colspan="2" class="text-center border-l">Non OJD</th><th colspan="2" class="text-center border-l">VN Acte</th><th colspan="2" class="text-center border-l">App</th><th colspan="2" class="text-center border-l bg-purple-100 text-purple-900">Total</th></tr></thead>`;
            const dy = `<tr class="bg-purple-50 border-b-2 border-purple-200 font-bold text-purple-900"><td class="px-2 py-2 sticky left-0 bg-purple-50 z-10">MOY. LISS√âE</td>${['abo_ojd', 'abo_non_ojd', 'ventes_num', 'abo_android_apple'].map(k => tdsDigYTD(ytd, k)).join(' ')}<td class="text-right border-l px-2">${kAvg('totalNumerique')}</td><td class="text-center px-2">${formatPercent(calcPct(kAvg('totalNumerique'), kPrev('totalNumerique')))}</td></tr>`;
            document.getElementById('digital-table-container').innerHTML = `<table class="w-full text-xs whitespace-nowrap">${dh}<tbody>${dy}${digitalRows}</tbody></table>`;

            const ctx = document.getElementById('mainChart').getContext('2d'); if (mainChart) mainChart.destroy();
            mainChart = new Chart(ctx, { type: 'line', data: { labels: lbls, datasets: [{ label: `R√©alis√© ${year}`, data: real, borderColor: '#2563eb', backgroundColor: 'rgba(37,99,235,0.1)', fill: true }, { label: `R√©alis√© ${year - 1}`, data: n1, borderColor: '#9ca3af', borderDash: [5, 5], fill: false }, { label: 'Budget', data: bud, borderColor: '#dc2626', fill: false }] }, options: { responsive: true, maintainAspectRatio: false } });
        }

        function tds(r, b, n, bg = '', isFut = false) {
            if (isFut) return `<td class="px-1 text-right border-l ${bg}">-</td><td class="px-1 text-right ${bg}">-</td><td class="px-1 text-center ${bg}">-</td><td class="px-1 text-center ${bg}">-</td>`;
            return `<td class="px-1 text-right border-l ${bg}">${formatNumber(r)}</td><td class="px-1 text-right ${bg}">${formatNumber(b)}</td><td class="px-1 text-center ${bg}">${formatPercent(calcPct(r, b))}</td><td class="px-1 text-center ${bg}">${formatPercent(calcPct(r, n))}</td>`;
        }
        function tdsYTD(y, k) { if (!y.cnt) return '<td></td><td></td><td></td><td></td>'; const r = y.r[k] / y.cnt, p = y.p[k] / y.cnt, b = y.b[k] / y.cnt; return `<td class="px-1 text-right border-l">${formatNumber(r)}</td><td class="px-1 text-right">${formatNumber(b)}</td><td class="px-1 text-center">${formatPercent(calcPct(r, b))}</td><td class="px-1 text-center">${formatPercent(calcPct(r, p))}</td>`; }
        function td_dig(r, p, isFut = false) {
            if (isFut) return `<td class="text-right border-l px-2">-</td><td class="text-center px-2">-</td>`;
            return `<td class="text-right border-l px-2">${formatNumber(r)}</td><td class="text-center px-2">${formatPercent(calcPct(r, p))}</td>`;
        }
        function tdsDigYTD(y, k) { if (!y.cnt) return '<td></td><td></td>'; const r = y.r[k] / y.cnt, p = y.p[k] / y.cnt; return `<td class="text-right border-l px-2">${formatNumber(r)}</td><td class="text-center px-2">${formatPercent(calcPct(r, p))}</td>`; }

        function updateSplitCharts(data) {
            const valid = data.filter(d => d.month); const denom = valid.length || 1;
            let s = { p: 0, po: 0, n: 0, v: 0, c: 0, ojd: 0, nojd: 0, vn: 0, app: 0 };
            valid.forEach(d => {
                const a = getAggregates(d);
                s.p += safe(d.porte); s.po += safe(d.poste); s.v += safe(d.ventes); s.c += safe(d.cf); s.n += safe(a.totalNumerique);
                s.ojd += safe(d.abo_ojd); s.nojd += safe(d.abo_non_ojd); s.vn += safe(d.ventes_num); s.app += safe(d.abo_android_apple);
            });
            const d1 = [s.p / denom, s.po / denom, s.n / denom, s.v / denom, s.c / denom], d2 = [s.ojd / denom, s.nojd / denom, s.vn / denom, s.app / denom];
            if (splitChart) splitChart.destroy(); splitChart = new Chart(document.getElementById('splitChart'), { type: 'doughnut', data: { labels: ['Port', 'Post', 'Num', 'VN', 'CF'], datasets: [{ data: d1.map(Math.round), backgroundColor: ['#2563eb', '#0ea5e9', '#8b5cf6', '#f59e0b', '#ef4444'] }] }, options: { responsive: true, maintainAspectRatio: false, cutout: '55%', plugins: { legend: { position: 'bottom' }, datalabels: { color: 'white', formatter: (v, c) => ((v / c.chart.data.datasets[0].data.reduce((a, b) => a + b, 0)) * 100).toFixed(1) + '%' } } } });
            if (splitNumChart) splitNumChart.destroy(); splitNumChart = new Chart(document.getElementById('splitNumChart'), { type: 'doughnut', data: { labels: ['OJD', 'Non', 'VN', 'App'], datasets: [{ data: d2.map(Math.round), backgroundColor: ['#7c3aed', '#a78bfa', '#22c55e', '#f97316'] }] }, options: { responsive: true, maintainAspectRatio: false, cutout: '55%', plugins: { legend: { position: 'bottom' }, datalabels: { color: 'white', formatter: (v, c) => ((v / c.chart.data.datasets[0].data.reduce((a, b) => a + b, 0)) * 100).toFixed(1) + '%' } } } });
        }

        function exportJSON() { const a = document.createElement('a'); a.download = 'data.json'; a.href = URL.createObjectURL(new Blob([JSON.stringify(DB_DATA, null, 2)], { type: 'application/json' })); a.click(); }
        function importJSON(i) { const f = i.files[0]; if (!f) return; const r = new FileReader(); r.onload = (e) => { try { const j = JSON.parse(e.target.result); if (Array.isArray(j)) { if (confirm('Remplacer donn√©es ?')) { DB_DATA = j; saveAllData(); populateYearSelects(); updateDashboard(); alert('OK'); } } } catch { alert('Err'); } }; r.readAsText(f); i.value = ''; }

        // --- NOUVEL EXPORT PDF & EXCEL ---

        function downloadPDF() {
            const element = document.getElementById('view-dashboard');
            const opt = {
                margin: 5,
                filename: "Rapport_OJD_" + state.selectedJournal + "_" + state.selectedYear + ".pdf",
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true },
                jsPDF: { unit: 'mm', format: 'a3', orientation: 'landscape' }
            };
            // On masque temporairement les boutons pour le PDF
            const filters = document.getElementById('dashboard-filters');
            filters.style.display = 'none';

            html2pdf().set(opt).from(element).save().then(() => {
                filters.style.display = 'flex';
            });
        }

        function exportExcel() {
            const table = document.querySelector('#main-table-container table');
            if (!table) return alert('Tableau introuvable');

            // Cr√©ation du workbook
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.table_to_sheet(table);

            // Ajustement auto des colonnes (largeur min)
            const colWidths = [];
            for (let i = 0; i < 30; i++) colWidths.push({ wch: 10 });
            ws['!cols'] = colWidths;

            XLSX.utils.book_append_sheet(wb, ws, "Synthese Mensuelle");
            XLSX.writeFile(wb, "Synthese_Mensuelle_" + state.selectedJournal + "_" + state.selectedYear + ".xlsx");
        }

        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>

</html>